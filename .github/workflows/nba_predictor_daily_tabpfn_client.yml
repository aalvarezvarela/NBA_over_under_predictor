name: Daily NBA Predictor TABPFN Client (Local Runner)

on:
    workflow_dispatch:
    # schedule:
    #     # Madrid (CET, UTC+1): 18, 20, 21, 22, 23, 24 -> UTC: 17, 19, 20, 21, 22, 23
    #     - cron: "01 19 * * *"
    #     - cron: "01 20 * * *"
    #     - cron: "01 21 * * *"
    #     - cron: "01 22 * * *"
    #     - cron: "01 23 * * *"

concurrency:
    group: daily-nba-predictor-tabpfn-client
    cancel-in-progress: true

permissions:
    contents: read
    id-token: write

jobs:
    run:
        runs-on: self-hosted
        env:
            PYTHONWARNINGS: "ignore::UserWarning,ignore::DeprecationWarning,ignore::FutureWarning,ignore::PerformanceWarning"

            # Critical for resolving imports that live under src/
            PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/src

            DB_ENV: supabase
            SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
            SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
            TABPFN_ACCESS_TOKEN: ${{ secrets.TABPFN_ACCESS_TOKEN }}
            S3_AWS_PROFILE: ""

            # Cron runs in UTC; keep runtime consistent
            TZ: UTC

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: eu-west-1

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements_tabpfn.txt

            - name: Run NBA predictor
              run: python scripts/predict_nba_games.py
