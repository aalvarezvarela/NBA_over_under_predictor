name: Daily NBA Predictor (Local Runner)

on:
    workflow_dispatch:
        inputs:
            date:
                description: "Prediction date: YYYY-MM-DD, today, tomorrow (leave empty for default: today)"
                required: false
                default: ""
    schedule:
        # Madrid (CET, UTC+1): 18, 20, 21, 22, 23, 24 -> UTC: 17, 19, 20, 21, 22, 23
        - cron: "01 19 * * *"
        - cron: "01 20 * * *"
        - cron: "01 21 * * *"
        - cron: "01 22 * * *"
        - cron: "01 23 * * *"

concurrency:
    group: daily-nba-predictor
    cancel-in-progress: true

permissions:
    contents: read
    id-token: write

jobs:
    run:
        runs-on: self-hosted
        env:
            PYTHONWARNINGS: "ignore::UserWarning,ignore::DeprecationWarning,ignore::FutureWarning"

            # Critical for resolving imports that live under src/
            PYTHONPATH: ${{ github.workspace }}:${{ github.workspace }}/src

            DB_ENV: supabase
            SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
            SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
            ODDS_API_KEY: ${{ secrets.ODDS_API_KEY }}
            S3_AWS_PROFILE: ""

            # Cron runs in UTC; keep runtime consistent
            TZ: UTC

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Configure AWS credentials (OIDC)
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: eu-west-1

            - name: Verify AWS identity
              run: |
                  aws sts get-caller-identity

            - name: Verify S3 access
              run: |
                  aws s3 ls s3://adrian-nba-model-registry-eu-west-1/models/

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: Run NBA predictor
              run: python scripts/predict_nba_games.py
