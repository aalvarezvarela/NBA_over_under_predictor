name: Update Finished Matches Total Points (Local Runner)

on:
    workflow_dispatch:
    schedule:
        # Daily at 7am, 8am, and 10am UTC
        - cron: "23 6 * * *"
        - cron: "2 7 * * *"
        - cron: "2 8 * * *"
        - cron: "27 11 * * *"

permissions:
    contents: read

jobs:
    run:
        # Target your local machine
        runs-on: self-hosted

        env:
            PYTHONWARNINGS: "ignore::UserWarning,ignore::DeprecationWarning,ignore::FutureWarning"

            # Supabase
            DB_ENV: supabase
            SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
            SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            # Optional but recommended on self-hosted runners
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt

            - name: DB sanity check
              run: |
                  python - <<'PY'
                  import os, psycopg
                  dsn = os.environ["SUPABASE_DB_URL"]
                  with psycopg.connect(dsn) as conn:
                    with conn.cursor() as cur:
                      cur.execute("select current_database(), current_user;")
                      print(cur.fetchone())
                  PY

            - name: Update finished matches
              run: |
                  cd src
                  python update_finished_matches.py
